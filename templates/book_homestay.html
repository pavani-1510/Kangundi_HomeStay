{% extends "base.html" %}

{% block title %}Book Homestay - Kangundi{% endblock %}

{% block content %}
<div class="booking-page">
    <div class="back-btn-wrapper">
        <a href="{{ url_for('homestay_details', homestay_id=homestay.id) }}" class="back-link">← Back to Details</a>
    </div>

    <div class="booking-container">
        <div class="booking-header">
            <h1 class="booking-title">Reserve Your Stay</h1>
            <p class="booking-subtitle">at {{ homestay.owner }}</p>
        </div>

        <div class="booking-content">
            <div class="property-summary">
                <div class="summary-card">
                    <div class="summary-label">Owner</div>
                    <div class="summary-value">{{ homestay.owner }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Price per Night</div>
                    <div class="summary-value">₹{{ homestay.price }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Rooms</div>
                    <div class="summary-value">{{ homestay.rooms }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Beds</div>
                    <div class="summary-value">{{ homestay.beds }}</div>
                </div>
            </div>

            <form method="POST" class="booking-form" onchange="updateAvailability()">
                <div class="form-section">
                    <h3 class="form-section-title">Select Your Dates</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="from_date">From Date *</label>
                            <input type="date" id="from_date" name="from_date" required>
                        </div>
                        <div class="form-group">
                            <label for="till_date">Till Date *</label>
                            <input type="date" id="till_date" name="till_date" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="form-section-title">Beds Required</h3>
                    
                    <div class="form-group full">
                        <label for="beds_requested">Number of Beds *</label>
                        <select id="beds_requested" name="beds_requested" required>
                            <option value="">Select number of beds</option>
                            {% for i in range(1, homestay.beds + 1) %}
                            <option value="{{ i }}">{{ i }} bed{{ 's' if i > 1 else '' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="availability-section">
                    <div id="availability-info" class="availability-info">
                        Select dates and beds to check availability
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="submit-btn" disabled>Continue to Payment</button>
            </form>
        </div>
    </div>
</div>

<script>
const availabilityData = {{ availability | tojson }};
const totalBeds = {{ homestay.beds }};

function updateAvailability() {
    const fromDate = document.getElementById('from_date').value;
    const tillDate = document.getElementById('till_date').value;
    const bedsRequested = parseInt(document.getElementById('beds_requested').value) || 0;
    const availabilityInfo = document.getElementById('availability-info');
    const submitBtn = document.getElementById('submit-btn');

    if (!fromDate || !tillDate) {
        availabilityInfo.textContent = 'Select dates to check availability';
        submitBtn.disabled = true;
        return;
    }

    if (new Date(tillDate) <= new Date(fromDate)) {
        availabilityInfo.innerHTML = '<span class="error">Till date must be after from date</span>';
        submitBtn.disabled = true;
        return;
    }

    if (bedsRequested === 0) {
        availabilityInfo.textContent = 'Select number of beds';
        submitBtn.disabled = true;
        return;
    }

    // Check availability for the date range
    let minAvailable = totalBeds;
    let currentDate = new Date(fromDate);
    const endDate = new Date(tillDate);
    let hasFullyBookedDay = false;

    while (currentDate < endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayInfo = availabilityData[dateStr];
        
        if (dayInfo) {
            if (dayInfo.is_fully_booked) {
                hasFullyBookedDay = true;
            }
            minAvailable = Math.min(minAvailable, dayInfo.available);
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
    }

    // Display availability status
    if (hasFullyBookedDay) {
        availabilityInfo.innerHTML = '<span class="unavailable">⚠️ Fully Booked</span>';
        submitBtn.disabled = true;
    } else if (bedsRequested > minAvailable) {
        availabilityInfo.innerHTML = `<span class="unavailable">❌ Only ${minAvailable} bed(s) available</span>`;
        submitBtn.disabled = true;
    } else {
        availabilityInfo.innerHTML = `<span class="available">✓ ${minAvailable} bed(s) available</span>`;
        submitBtn.disabled = false;
    }
}

// Set min date to today
const today = new Date().toISOString().split('T')[0];
document.getElementById('from_date').min = today;
document.getElementById('till_date').min = today;
</script>

<style>
:root {
    --primary: #1f2937;
    --secondary: #6b7280;
    --accent: #10b981;
    --accent-dark: #059669;
    --border: #e5e7eb;
    --background: #f9fafb;
    --text: #111827;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.booking-page {
    background: white;
    min-height: 100vh;
    padding: 40px 16px;
}

.back-btn-wrapper {
    max-width: 900px;
    margin: 0 auto 40px;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--secondary);
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    padding: 6px 10px;
}

.back-link:hover {
    color: var(--primary);
    transform: translateX(-3px);
}

.booking-container {
    max-width: 900px;
    margin: 0 auto;
}

.booking-header {
    text-align: center;
    margin-bottom: 48px;
    padding: 0 20px;
}

.booking-title {
    font-size: 36px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
}

.booking-subtitle {
    font-size: 16px;
    color: var(--secondary);
    font-weight: 500;
}

.booking-content {
    display: flex;
    flex-direction: column;
    gap: 32px;
}

.property-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
}

.summary-card {
    background: var(--background);
    border-radius: 8px;
    border: 1px solid var(--border);
    padding: 20px 16px;
    text-align: center;
}

.summary-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.summary-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
}

.booking-form {
    background: white;
    border-radius: 8px;
    border: 1px solid var(--border);
    padding: 32px;
    display: flex;
    flex-direction: column;
    gap: 28px;
}

.form-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.form-section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
}

.form-group input,
.form-group select {
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.availability-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 20px;
    background: var(--background);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.availability-info {
    padding: 16px;
    border-radius: 6px;
    background: white;
    border: 2px solid var(--border);
    font-weight: 600;
    text-align: center;
    color: var(--secondary);
    font-size: 14px;
    min-height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.availability-info .available {
    color: var(--accent-dark);
    border-color: var(--accent);
    background: #f0fdf4;
    font-weight: 700;
}

.availability-info .unavailable {
    color: #dc2626;
    border-color: #fecaca;
    background: #fef2f2;
    font-weight: 700;
}

.availability-info .error {
    color: #dc2626;
}

.btn-submit {
    padding: 14px 28px;
    border: none;
    border-radius: 6px;
    background: var(--accent);
    color: white;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    margin-top: 8px;
}

.btn-submit:hover:not(:disabled) {
    background: var(--accent-dark);
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    transform: translateY(-2px);
}

.btn-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media (max-width: 1024px) {
    .property-summary {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .booking-page {
        padding: 24px 16px;
    }

    .booking-header {
        margin-bottom: 36px;
    }

    .booking-title {
        font-size: 28px;
    }

    .booking-form {
        padding: 24px;
    }

    .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .property-summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .summary-card {
        padding: 16px 12px;
    }

    .summary-value {
        font-size: 20px;
    }
}

@media (max-width: 480px) {
    .booking-page {
        padding: 16px 12px;
    }

    .booking-header {
        margin-bottom: 28px;
    }

    .booking-title {
        font-size: 24px;
    }

    .booking-subtitle {
        font-size: 14px;
    }

    .booking-form {
        padding: 20px 16px;
        gap: 20px;
    }

    .property-summary {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .summary-card {
        padding: 14px 12px;
    }

    .form-row {
        gap: 10px;
    }

    .form-group input,
    .form-group select {
        padding: 10px 12px;
        font-size: 13px;
    }

    .btn-submit {
        padding: 12px 24px;
        font-size: 14px;
    }
}
</style>
{% endblock %}
